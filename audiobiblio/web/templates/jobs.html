{% extends "base.html" %}
{% set active = 'jobs' %}
{% block title %}Jobs — audiobiblio{% endblock %}
{% block content %}
<h2>Download Jobs <small>({{ total }})</small></h2>

{% if approval_count > 0 %}
<article>
    <header>
        <strong>Approval Queue</strong> — {{ approval_count }} jobs awaiting review
        <button class="outline secondary" style="float:right"
                hx-post="/api/v1/jobs/approve-all"
                hx-swap="none"
                hx-confirm="Approve all {{ approval_count }} jobs?"
                onclick="this.setAttribute('aria-busy','true'); setTimeout(() => location.reload(), 500)">
            Approve All
        </button>
    </header>
    <table role="grid">
        <thead>
            <tr><th>#</th><th>Episode</th><th>Work</th><th>Type</th><th>Proposed Path</th><th></th></tr>
        </thead>
        <tbody>
        {% for j in approval_jobs %}
            <tr>
                <td>{{ j.id }}</td>
                <td>{{ j.episode.title if j.episode else '?' }}</td>
                <td>{{ j.episode.work.title if j.episode and j.episode.work else '' }}</td>
                <td>{{ j.asset_type.value }}</td>
                <td><code style="font-size:0.8em">{{ j.proposed_path or '' }}</code></td>
                <td>
                    <button class="outline"
                            hx-post="/api/v1/jobs/{{ j.id }}/approve"
                            hx-swap="none"
                            onclick="this.setAttribute('aria-busy','true'); setTimeout(() => location.reload(), 300)">
                        Approve
                    </button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}

<div class="grid">
    <div>
        <select name="status"
                hx-get="/jobs"
                hx-target="body"
                hx-push-url="true"
                hx-vals='{"page": 1}'>
            <option value="">All statuses</option>
            {% for s in statuses %}
            <option value="{{ s }}" {% if s == status_filter %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
    </div>
    <div style="text-align:right">
        <button hx-post="/api/v1/jobs/retry-all-failed" hx-swap="none"
                hx-confirm="Retry all failed jobs?"
                class="secondary outline"
                onclick="this.setAttribute('aria-busy','true')">
            Retry All Failed
        </button>
    </div>
</div>

<table role="grid">
    <thead>
        <tr>
            <th>#</th><th>Episode</th><th>Work</th><th>Type</th>
            <th>Status</th><th>Error</th><th>Created</th><th></th>
        </tr>
    </thead>
    <tbody id="job-rows"
           hx-get="/_partials/job_rows{% if status_filter %}?status={{ status_filter }}{% endif %}"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
    {% for j in jobs %}
        {% include '_partials/job_row.html' %}
    {% endfor %}
    </tbody>
</table>

{% if pages > 1 %}
<nav>
    <ul>
        {% if page > 1 %}
        <li><a href="/jobs?page={{ page-1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a></li>
        {% endif %}
        <li>Page {{ page }} / {{ pages }}</li>
        {% if page < pages %}
        <li><a href="/jobs?page={{ page+1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}
